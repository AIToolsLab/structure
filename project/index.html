<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <title>AI for Writers</title>
    <link rel="stylesheet" href="/styles/main_page.css" type="text/css">
</head>

<body>
    <div class="main_container">
        <div class="outline_container">
            <h2>Outline</h2>
            <span id="outline-0">First par</span>
            <br>
            <br>
            <span id="outline-1">Second par</span>
            <!-- <p><span class="outline_tip" data-hover="Are you sure about that?">Learning through travel by -->
            <!-- using the example of a trip to Greece.</span> -->
            <!-- </p> -->
            <br>
            <br>
            <span id="outline-2">Third par
            </span>
            <br>
            <br>
            <span id="outline-3">Fourth par</span>
            <br>
            <br>
            <span id="outline-4">Fifth par</span>
            <button class="rev" onclick="getLogProbs()">Find Logprobs</button>

            <br>
            <button class="rev" onclick="makeMatches()">Find Matches</button>


            <div class="outline-comment-container">
                Comment section
            </div>
        </div>

        <div class="text_container" id="essay_text_id">
            <h2>Text</h2>
            <span class="popup-trigger">Meet Jack.</span>
            <br>
            <br>
            <span>He's a driven and ambitious individual with a laser-focused mindset on achieving his goals.</span>
            <br>
            <br>
            <span>With a keen eye for detail, he excels in problem-solving and is always seeking new challenges to test his abilities.</span>
            <br>
            <br>
            <span>Jack is a natural leader, with the ability to inspire and motivate others to perform at their best.</span>
            <br>
            <br>
            <span>Despite his demanding schedule, he always makes time for his family and friends, valuing the importance of maintaining strong relationships.</span>
            <br>
            <br>

            <div class="text-comment-container">
                Comment section
            </div>
        </div>



        </div>



        <div>

        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                resetSpanIds();
            });
            
            function resetSpanIds() {
                // Give unique IDs to all the spans of the text
                // Get the div element by its ID
                var divElement = document.getElementById("essay_text_id");

                // Get all the span elements inside the div element
                var spanElements = divElement.getElementsByTagName("span");

                // Loop through each span element and add an id attribute
                for (var i = 0; i < spanElements.length; i++) {
                  spanElements[i].setAttribute("id", "span-" + (i));
                }
            }

            function resetChooseSentenceAttribute() {
                // Get the div element by its ID where text spans are residing
                const divElement = document.getElementById("essay_text_id");
                // Get all the span elements inside the div element
                const spanElements = divElement.getElementsByTagName("span");
                // Loop through each span element and add an onclick attribute
                for (var i = 0; i < spanElements.length; i++) {
                  spanElements[i].setAttribute("onclick", "chooseSentence()");
                }     
            }

            getLogProbs = async () => {
                const response = await fetch("http://127.0.0.1:8000/item/logprobs");
                data = await response.json();
                console.log("got data: ", data);
                document.querySelector(".text-comment-container").innerHTML = "Consider moving 'It took me eighteen years to realize what an extraordinary influence my mother has been on my life.' sentence to the following place:"
                let comment_content = document.querySelector(".text-comment-container");
                // for (let i = 0; i < highestIndexes.length; i++) {
                //     const n_before = (highestIndexes[i]-1).toString();
                //     const n_after = (highestIndexes[i]+1).toString();
                //     const sen_before =  document.querySelector("#span-"+ n_before).innerHTML;
                //     const sen_after = document.querySelector("#span-" + n_after).innerHTML;
                //     comment_content.innerHTML = comment_content.innerHTML + "<br>" + (i+1).toString() + ". After '" + sen_before + "' and before '" + sen_after + "'.<br>";
                // }
                
                resetChooseSentenceAttribute();
            }

            // Define the getSpanId function to handle the click event
            function chooseSentence() {
                console.log("DATA: ", data);
                var span_id = event.target.id; // Get the ID of the clicked span
                
                // Highlighting sentence on click
                const highlighting_sen = document.getElementById(span_id);
                // console.log(highlighting_sen.innerHTML);
                highlighting_sen.classList.toggle("highlighted");

                // Extract number from the id of a span
                const match = span_id.match(/-(\d+)/); // matches the dash followed by one or more digits
                num = match ? parseInt(match[1], 10) : null; // extracts the number and returns it as a parsed integer

                // Get highest indexes of logprobs
                highest_indexes = getHighestIndexes(data[num], 3);

                // Create span with empty spaces where the current sentence can move
                for (let i = 0; i < highest_indexes.length; i++) {
                    // If the suggested place is not the same as where the sentence is currently is
                    if (highest_indexes[i] !== num) {
                        // Create a span
                        const temp_span = document.createElement("span");
                        temp_span.setAttribute("class", "option");
                        temp_span.style.backgroundColor = "green";
                        temp_span.innerHTML = "&nbsp;&nbsp;&nbsp;&nbsp;";
                        const option = document.getElementById("span-" + highest_indexes[i].toString()).insertAdjacentElement("afterend", temp_span);

                        const excluded_spans = document.querySelectorAll('.option');

                        // Detecting mouse click
                        document.addEventListener('mousedown', function(event) {
                            console.log("mouse detected");
                            // If clicked not on the alternative places
                            if (!Array.from(excluded_spans).includes(event.target)) {
                                console.log("clicked somewhere else");
                                const options = document.getElementsByClassName('option');
                                for (let index = 0; index < excluded_spans.length; index++) {
                                  excluded_spans[index].remove();
                                }
                                // Unhighlight
                                highlighting_sen.classList.remove("highlighted");
                            }
                            else {
                                // If suggestion is picked...
                                // Change content of empty span
                                temp_span.addEventListener("click", function() {
                                    temp_span.style.backgroundColor = "white";
                                    temp_span.innerHTML = highlighting_sen.innerHTML;
                                    temp_span.classList.remove("option");
                                    // Remove initial span of interest
                                    highlighting_sen.remove();
                                    const options = document.getElementsByClassName("option");
                                    // Remove remaining spans that were not chosen by the user
                                    while (options.length > 0) {
                                        options[0].remove();
                                    }
                                    resetSpanIds();
                                    resetChooseSentenceAttribute();
                                    return;
                                });
                            }
                        });

                    }

                    


                }



            }


            // Find intexes of three lowest integers in a list
            // Top 'num' elements
            function getHighestIndexes(list, num) {
                const sortedList = [...list].sort((a, b) => b - a); // Make a sorted copy of the list
                const indexes = [];

                // Get the index of the first three elements in the sorted list
                for (let i = 0; i < num; i++) {
                  const index = list.indexOf(sortedList[i]);
                  indexes.push(index);
                }

                return indexes;
            }

            makeMatches = async () => {
                const response = await fetch("http://127.0.0.1:8000/item/match");
                const data = await response.json();
                colorMatches(data);
            }

            colorMatches = (data) => {
                console.log(data[0]);
                for (let j = 0; j < data.length; j++) {
                    const outline_par = "outline-" + j;
                    const indices_of_max = findIndicesOfMin(data[j], 3);
                    document.getElementById(outline_par).onmouseover = function () {
                        document.getElementById(outline_par).style.backgroundColor = "#f59b42";
                        for (let i = 0; i < indices_of_max.length; i++) {
                            const elem_id = "span-" + indices_of_max[i];
                            document.getElementById(elem_id).style.backgroundColor = "#f59b42";
                        }
                    }

                    document.getElementById(outline_par).onmouseleave = function () {
                        document.getElementById(outline_par).style.backgroundColor = "white";
                        for (let i = 0; i < indices_of_max.length; i++) {
                            const elem_id = "span-" + indices_of_max[i];
                            document.getElementById(elem_id).style.backgroundColor = "white";
                        }
                    }
                }
            }

            // https://stackoverflow.com/questions/11792158/optimized-javascript-code-to-find-3-largest-element-and-its-indexes-in-array
            function findIndicesOfMin(inp, count) {
                var outp = [];
                for (var i = 0; i < inp.length; i++) {
                    outp.push(i); // add index to output array
                    if (outp.length >= count) {
                        outp.sort(function (a, b) { return inp[a] - inp[b]; }); // ascending sort the output array
                        outp.pop(); // remove the last index (index of largest element in output array)
                    }
                }
                return outp;
            }



            makeChanges = async () => {
                // Change HTML section with received data
                console.log("received");
                const response = await fetch("http://127.0.0.1:8000/item");
                const data = await response.json();
                // console.log(data);
                assessFix(data);
            }

            assessFix = (data) => {
                console.log(data)
                for (let i = 0; i < data.length; i++) {
                    const span_id = "span-" + i;
                    for (let j = 0; j < data.length; j++) {
                        const new_index = data[j]["new-order"];
                        if (new_index == i) {
                            const curr_span = document.getElementById(span_id);
                            curr_span.insertAdjacentHTML(
                                "afterend",
                                `<span class="${span_id}">${data[j]['text']}</span>`,
                            );
                            curr_span.remove();
                        }
                    }
                }
            }

        </script>
</body>

</html>